<!DOCTYPE html>
<html lang="en" data-language="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACIInfotech - AI Assistant</title>

  <!-- Favicon to prevent /favicon.ico 404 -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px;
    }
    .chat-container { width: 100%; max-width: 800px; height: 90vh; background: white; border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,.1); display: flex; flex-direction: column; overflow: hidden; }
    .chat-header { background: linear-gradient(45deg, #667eea, #764ba2); color:#fff; padding:20px; text-align:center; position:relative; }
    .chat-header h1 { font-size: 24px; margin-bottom: 5px; }
    .chat-header p { font-size:14px; opacity: .9; }

    .upload-section { padding: 15px 20px; border-bottom: 1px solid #eee; background: #f8f9fa; }
    .file-upload { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .file-input-wrapper { position:relative; display:inline-block; }
    .file-input { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }
    .file-input-button { background:#667eea; color:#fff; padding:8px 16px; border-radius:8px; font-size:14px; cursor:pointer; transition:background .3s; }
    .file-input-button:hover { background:#5a6fd8; }
    .upload-button { background:#28a745; color:#fff; padding:8px 16px; border:none; border-radius:8px; cursor:pointer; font-size:14px; transition:background .3s; }
    .upload-button:hover { background:#218838; }
    .upload-button:disabled { background:#6c757d; cursor:not-allowed; }
    .upload-button.loading { position:relative; color:transparent; }
    .upload-button.loading::after { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:16px; height:16px; border:2px solid transparent; border-top:2px solid #fff; border-radius:50%; animation:spin 1s linear infinite; }
    .selected-files { font-size:12px; color:#666; flex:1; min-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .chat-messages { flex:1; overflow-y:auto; padding:20px; background:#f8f9fa; }
    .message { margin-bottom:20px; display:flex; animation:fadeIn .3s ease-in; }
    .message.user { flex-direction: row-reverse; }
    .message-content { max-width:70%; padding:15px 20px; border-radius:20px; position:relative; word-wrap:break-word; line-height:1.4; }
    .message.user .message-content { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; border-bottom-right-radius:5px; }
    .message.assistant .message-content { background:#fff; color:#333; border:1px solid #e0e0e0; border-bottom-left-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,.1); }

    .message-content p:first-child { margin-top:0; }
    .message-content p:last-child { margin-bottom:0; }

    .message-image { max-width:100%; border-radius:10px; margin-top:10px; display:block; cursor:pointer; transition:opacity .3s; }
    .message-image.loading { opacity:.5; }
    .message-image.error { opacity:.7; border:2px solid #dc3545; }

    .message-content a { display:block; text-decoration:none; }

    .message-avatar { width:40px; height:40px; border-radius:50%; margin:0 10px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; font-size:14px; flex-shrink:0; }
    .message.user .message-avatar { background:#667eea; }
    .message.assistant .message-avatar { background:#28a745; }

    .chat-input-container { padding:20px; background:#fff; border-top:1px solid #e0e0e0; }
    .chat-input-wrapper { display:flex; gap:10px; align-items:center; }

    .chat-input { flex:1; padding:15px 20px; border:2px solid #e0e0e0; border-radius:25px; font-size:16px; outline:none; transition:border-color .3s; }
    .chat-input:focus { border-color:#667eea; }

    .send-button { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:transform .2s, background-color .3s; flex-shrink:0; }
    .send-button:hover { transform: scale(1.05); }
    .send-button:disabled { background:#ccc; cursor:not-allowed; transform:none; }

    .typing-indicator { display:none; margin-bottom:20px; }
    .typing-indicator .message-content { display:flex; align-items:center; gap:5px; }
    .typing-dot { width:8px; height:8px; border-radius:50%; background:#667eea; animation:typing 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1){ animation-delay:-.32s; }
    .typing-dot:nth-child(2){ animation-delay:-.16s; }

    .status-indicator { padding:10px 20px; border-radius:5px; margin:10px 20px; font-size:14px; text-align:center; display:none; }
    .status-indicator.success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
    .status-indicator.error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
    .status-indicator.info { background:#cce5ff; border:1px solid #b8daff; color:#004085; }

    .welcome-message { text-align:center; padding:40px 20px; color:#666; }
    .welcome-message h2 { color:#667eea; margin-bottom:10px; }

    .chat-messages::-webkit-scrollbar { width:6px; }
    .chat-messages::-webkit-scrollbar-track { background:#f1f1f1; border-radius:10px; }
    .chat-messages::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:10px; }
    .chat-messages::-webkit-scrollbar-thumb:hover { background:#a8a8a8; }

    @media (max-width: 768px){
      .chat-container { width:100%; max-width:100%; height:100vh; border-radius:0; padding:0; }
      .chat-header { border-radius:0; }
      .message-content { max-width:85%; }
      .message-image { width:100%; }
      .chat-header h1 { font-size:20px; }
      .file-upload { flex-direction:column; align-items:stretch; }
      .file-input-wrapper, .upload-button { width:100%; margin-bottom:10px; }
      .selected-files { width:100%; text-align:center; margin-top:5px; }
      .chat-input-container { padding:15px; }
      .chat-input { padding:12px 15px; font-size:15px; }
      .send-button { width:45px; height:45px; }
    }

    @keyframes typing { 0%,80%,100%{ transform:scale(0);} 40%{ transform:scale(1);} }
    @keyframes fadeIn { from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }
    @keyframes spin { 0%{ transform:translate(-50%,-50%) rotate(0deg);} 100%{ transform:translate(-50%,-50%) rotate(360deg);} }

    /* Markdown rendering improvements */
    .message-content strong { font-weight:700; }
    .message.assistant .message-content p:first-child strong {
      display:block; margin-bottom:6px;
    }
    .message-content ul, .message-content ol { padding-left:1.2rem; margin:.5rem 0; }
    .message-content li { margin:.25rem 0; }
  </style>

  <!-- Markdown + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>

<body>
  <div class="chat-container" role="main" aria-label="ACIInfotech AI Assistant Chat Interface">
    <div class="chat-header">
      <h1>ACIInfotech AI Assistant</h1>
    </div>

    <div class="upload-section">
      <div class="file-upload">
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.txt"
                 aria-label="Choose PDF or TXT files" aria-controls="uploadButton selectedFiles">
          <div class="file-input-button" role="button" aria-label="Choose files">Choose Files (PDF/TXT)</div>
        </div>
        <button id="uploadButton" class="upload-button" disabled aria-label="Upload selected files">Upload & Initialize</button>
        <div id="selectedFiles" class="selected-files" role="status" aria-live="polite">No files selected</div>
      </div>
    </div>

    <div id="statusIndicator" class="status-indicator"></div>

    <div class="chat-messages" id="chatMessages" role="log" aria-live="polite">
      <div class="welcome-message" role="region" aria-label="Welcome Message">
        <h2>Welcome to ACIInfotech!</h2>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <input type="text" id="chatInput" class="chat-input" placeholder="Initializing assistant..." disabled
               aria-label="Type your message" aria-controls="sendButton">
        <button id="micButton" class="send-button" aria-label="Start voice input" title="Voice input">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 15C13.66 15 15 13.66 15 12V6C15 4.34 13.66 3 12 3C10.34 3 9 4.34 9 6V12C9 13.66 10.34 15 12 15Z" fill="currentColor"/>
            <path d="M19 11C19 14.31 16.31 17 13 17H11C7.69 17 5 14.31 5 11H3C3 15.42 6.58 19 11 19V22H13V19C17.42 19 21 15.42 21 11H19Z" fill="currentColor"/>
          </svg>
        </button>
        <button id="sendButton" class="send-button" disabled aria-label="Send message">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---------- GLOBAL STATE ----------
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const selectedFilesDiv = document.getElementById('selectedFiles');
    const statusIndicator = document.getElementById('statusIndicator');
    const chatMessagesContainer = document.getElementById('chatMessages');
    const micButton = document.getElementById('micButton');

    let sessionId = null;
    let isChatReady = false;
    let typingIndicatorMessageElement = null;

    // ---------- MARKDOWN ----------
    function renderMarkdownToHTML(md) {
      const raw = (window.marked ? marked.parse(md, { breaks: true }) : md);
      return window.DOMPurify ? DOMPurify.sanitize(raw) : raw;
    }
    function getDriveFileIdFromHref(href) {
      const m = href.match(/\/d\/([^\/?#]+)\//);
      return m ? m[1] : null;
    }
    function injectDriveThumbnails(container) {
      const anchors = container.querySelectorAll('a[href^="https://drive.google.com/"]');
      anchors.forEach(a => {
        const fileId = getDriveFileIdFromHref(a.href);
        if (!fileId) return;
        const img = document.createElement('img');
        img.src = `https://drive.google.com/thumbnail?id=${fileId}`;
        img.alt = 'Preview';
        img.className = 'message-image loading';
        img.onload = () => img.classList.remove('loading');
        img.onerror = () => { img.classList.remove('loading'); img.classList.add('error'); };
        a.insertAdjacentElement('afterend', img);
      });
    }

    // ---------- INIT ----------
    async function initializeAssistant() {
      chatInput.placeholder = "Connecting to assistant...";
      try {
        const sessionResponse = await fetch('/generate_session');
        if (!sessionResponse.ok) throw new Error(`Session failed: ${sessionResponse.status}`);
        const sessionData = await sessionResponse.json();
        sessionId = sessionData.session_id;

        const healthResponse = await fetch('/health');
        if (!healthResponse.ok) throw new Error(`Health check failed: ${healthResponse.status}`);
        const healthData = await healthResponse.json();

        if (healthData.status === 'healthy') {
          isChatReady = true;
          enableChat();
          const docCount = healthData.documents_indexed || 0;
          showStatus(`Assistant ready! ${docCount} document chunks indexed.`, 'success');
        } else {
          isChatReady = false;
          disableChat();
          showStatus('Assistant unavailable. Please upload documents or refresh.', 'error');
        }
      } catch (error) {
        console.error('Init error:', error);
        disableChat();
        showStatus(`Init failed: ${error.message}. Refresh page.`, 'error');
      }
    }

    function enableChat(){ chatInput.disabled=false; sendButton.disabled=false; chatInput.placeholder="Ask about ACIInfotech services..."; chatInput.focus(); }
    function disableChat(){ chatInput.disabled=true; sendButton.disabled=true; chatInput.placeholder="Assistant not ready or processing..."; }

    function showStatus(message, type='success'){
      statusIndicator.textContent = message;
      statusIndicator.className = `status-indicator ${type}`;
      statusIndicator.style.display = 'block';
      setTimeout(()=>{ if (statusIndicator.textContent===message) statusIndicator.style.display='none'; }, 7000);
    }

    // ---------- FILE UPLOAD ----------
    fileInput.addEventListener('change', function(e){
      const files = Array.from(e.target.files).filter(file =>
        /\.pdf$/i.test(file.name) || /\.txt$/i.test(file.name)
      );
      selectedFilesDiv.textContent = files.length
        ? `${files.length} file(s): ${files.map(f=>f.name).join(', ').substring(0,50)}...`
        : 'No valid PDF or TXT files';
      uploadButton.disabled = !files.length;
    });

    uploadButton.addEventListener('click', async function(){
      if (!fileInput.files.length){ showStatus('Please select files to upload', 'error'); return; }
      const formData = new FormData(); for (let f of fileInput.files) formData.append('files', f);
      this.disabled = true; this.classList.add('loading'); fileInput.disabled = true; disableChat();
      showStatus('Uploading and processing documents...', 'info');
      try{
        const response = await fetch('/upload_documents', { method:'POST', body: formData });
        const result = await response.json().catch(()=>({ error: 'Invalid JSON' }));
        if (response.ok){
          showStatus(result.message || 'Documents processed!', 'success');
          isChatReady = true; enableChat();
          // refresh counters
          const healthResponse = await fetch('/health'); const healthData = await healthResponse.json();
          const docCount = healthData.documents_indexed || 0;
          showStatus(`Processed! ${docCount} chunks indexed.`, 'success');
        } else {
          showStatus(result.error || 'Processing failed.', 'error');
          if (!isChatReady) await initializeAssistant();
        }
      } catch (error){
        console.error('Upload error:', error); showStatus(`Upload error: ${error.message}.`, 'error');
        if (!isChatReady) await initializeAssistant();
      } finally {
        this.classList.remove('loading'); this.disabled=false; fileInput.disabled=false; fileInput.value='';
        selectedFilesDiv.textContent='No files selected'; uploadButton.disabled=true;
      }
    });

    // ---------- CHAT RENDER ----------
    function createMessageElement(isUser=false, content=null, imageData=null, viewData=null){
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      avatarDiv.textContent = isUser ? 'You' : 'ACI';
      avatarDiv.setAttribute('aria-hidden','true');

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.setAttribute('role','log');

      if (imageData && (imageData.text || imageData.image)) {
        if (imageData.text) {
          const textParagraph = document.createElement('p');
          textParagraph.textContent = imageData.text;
          contentDiv.appendChild(textParagraph);
        }
        if (imageData.image && imageData.link) {
          const link = document.createElement('a'); link.href=imageData.link; link.target='_blank'; link.rel='noopener noreferrer';
          const img = document.createElement('img'); img.src=imageData.image; img.alt=imageData.alt || 'Preview';
          img.className='message-image loading'; img.setAttribute('role','img');
          img.onload=()=>img.classList.remove('loading');
          img.onerror=()=>{ img.classList.remove('loading'); img.classList.add('error'); img.alt='Image failed to load'; };
          link.appendChild(img); contentDiv.appendChild(link);
        }
      }
      else if (viewData && viewData.text && Array.isArray(viewData.views)) {
        const textParagraph = document.createElement('p'); textParagraph.textContent = viewData.text; contentDiv.appendChild(textParagraph);
        viewData.views.forEach(view=>{
          if (view.url && view.label){
            const link = document.createElement('a');
            link.href = view.url; link.target='_blank'; link.rel='noopener noreferrer'; link.textContent=view.label;
            link.style.display='inline-block'; link.style.marginTop='8px'; link.style.padding='6px 12px';
            link.style.background='#667eea'; link.style.color='#fff'; link.style.borderRadius='6px';
            link.style.textDecoration='none'; link.style.fontSize='14px'; link.style.marginRight='8px'; link.style.transition='background .3s';
            link.addEventListener('mouseover',()=>link.style.background='#5a6fd8');
            link.addEventListener('mouseout',()=>link.style.background='#667eea');
            contentDiv.appendChild(link);
          }
        });
      }
      else if (content) {
        contentDiv.innerHTML = renderMarkdownToHTML(content);
        injectDriveThumbnails(contentDiv);
      }
      else {
        const p = document.createElement('p'); p.textContent = '...'; contentDiv.appendChild(p);
      }

      messageDiv.appendChild(avatarDiv);
      messageDiv.appendChild(contentDiv);
      return messageDiv;
    }

    function addMessageToChat(element){
      const welcomeMessage = chatMessagesContainer.querySelector('.welcome-message');
      if (welcomeMessage) welcomeMessage.remove();
      chatMessagesContainer.appendChild(element);
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
      setTimeout(()=>{
        const lastImage = chatMessagesContainer.querySelector('.message:last-child img');
        if (lastImage){ lastImage.onload = ()=>{ chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; }; }
      }, 100);
    }

    function showTypingIndicator(){
      if (typingIndicatorMessageElement) return;
      typingIndicatorMessageElement = document.createElement('div');
      typingIndicatorMessageElement.className = 'message assistant typing-indicator';
      const avatarDiv = document.createElement('div'); avatarDiv.className='message-avatar'; avatarDiv.textContent='ACI'; avatarDiv.setAttribute('aria-hidden','true');
      const contentDiv = document.createElement('div'); contentDiv.className='message-content';
      ['typing-dot','typing-dot','typing-dot'].forEach((c,i)=>{ const dot=document.createElement('div'); dot.className=c; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%'; dot.style.background='#667eea'; dot.style.marginRight='6px'; dot.style.animation='typing 1.4s infinite ease-in-out'; dot.style.animationDelay=`${i*-0.16}s`; contentDiv.appendChild(dot); });
      typingIndicatorMessageElement.appendChild(avatarDiv); typingIndicatorMessageElement.appendChild(contentDiv);
      addMessageToChat(typingIndicatorMessageElement);
    }
    function hideTypingIndicator(){ if (typingIndicatorMessageElement){ typingIndicatorMessageElement.remove(); typingIndicatorMessageElement=null; } }

    // ---------- CHAT SEND ----------
    async function sendMessage(){
      const messageText = chatInput.value.trim(); if (!messageText) return;
      if (!isChatReady){ showStatus("Assistant not ready. Upload documents or wait.", 'error'); return; }

      addMessageToChat(createMessageElement(true, messageText));
      chatInput.value=''; showTypingIndicator(); disableChat();

      try{
        const response = await fetch('/chat', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: messageText, session_id: sessionId })
        });
        hideTypingIndicator();
        const data = await response.json().catch(()=>({ error:'Invalid JSON' }));

        if (response.ok) {
          if (data.type === 'image_link' && data.image) {
            addMessageToChat(createMessageElement(false, null, data));
          } else if (data.type === '360_view') {
            if (data.image && data.url) {
              addMessageToChat(createMessageElement(false, null, {
                text: data.response, image: data.image, link: data.url, alt: (data.label || "360° View") + " preview"
              }));
            } else if (Array.isArray(data.views)) {
              addMessageToChat(createMessageElement(false, null, null, data));
            } else if (typeof data.response === 'string') {
              addMessageToChat(createMessageElement(false, data.response));
            } else {
              addMessageToChat(createMessageElement(false, "No 360° view data received."));
            }
          } else if (typeof data.response === 'string') {
            addMessageToChat(createMessageElement(false, data.response));
          } else {
            addMessageToChat(createMessageElement(false, "Unexpected response received."));
            console.warn("Unexpected response:", data);
          }
        } else {
          const errorMessage = data.error || `Server error: ${response.status}`;
          addMessageToChat(createMessageElement(false, `Error: ${errorMessage}`));
          console.error("Chat API error:", response.status, data);
        }
      } catch (error){
        hideTypingIndicator(); console.error('Chat error:', error);
        addMessageToChat(createMessageElement(false, `Communication error: ${error.message}`));
      } finally {
        if (isChatReady) enableChat(); chatInput.focus();
      }
    }

    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e){
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    // ---------- VOICE (merged here so state exists) ----------
    let mediaRecorder; let audioChunks = [];
    micButton.addEventListener('click', async () => {
      if (!isChatReady) { showStatus("Assistant not ready. Upload documents first.", 'error'); return; }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showStatus("Microphone not supported in this browser.", "error"); return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append('audio', blob, 'voice.webm'); formData.append('session_id', sessionId);
          showTypingIndicator(); disableChat();
          try {
            const response = await fetch('/chat_voice', { method: 'POST', body: formData });
            const data = await response.json().catch(()=>({ error: 'Invalid JSON' }));
            hideTypingIndicator();
            if (response.ok) {
              if (data.transcript) addMessageToChat(createMessageElement(true, data.transcript));
              if (data.response)  addMessageToChat(createMessageElement(false, data.response));
              if (data.audio_url) new Audio(data.audio_url).play();
            } else {
              addMessageToChat(createMessageElement(false, data.error || "Voice error occurred."));
            }
          } catch (err) {
            hideTypingIndicator(); console.error("Voice error:", err);
            addMessageToChat(createMessageElement(false, `Voice error: ${err.message}`));
          } finally {
            stream.getTracks().forEach(t=>t.stop());
            if (isChatReady) enableChat(); chatInput.focus();
          }
        };
        mediaRecorder.start();
        showStatus("Recording... Speak now (5s)", "info");
        setTimeout(() => { if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop(); }, 5000);
      } catch (err) {
        console.error("Mic error:", err); showStatus("Microphone access denied or unavailable.", "error");
      }
    });

    // ---------- BOOT ----------
    document.addEventListener('DOMContentLoaded', initializeAssistant);
  </script>
</body>
</html>
